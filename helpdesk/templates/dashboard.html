{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block nav_dashboard_active %}is-active{% endblock %}
{% block header_actions %}
    <a href="{% url 'password_change' %}" class="header-action">Zmień hasło</a>
    {% if is_manager or user.is_superuser %}
        <a href="{% url 'admin:index' %}" class="header-action">Panel admina</a>
    {% endif %}
    <a href="{% url 'helpdesk:zgloszenie_nowe' %}" class="header-action header-action-primary">
        Nowe zgłoszenie
    </a>
{% endblock %}

{% block main_column %}
    <div class="column-main-header">
        Zgłoszenia
    </div>
    <div class="column-main-body">
        <style>
            .sort-link {
                color: inherit;
                text-decoration: none;
                font-weight: 600;
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }
            .sort-link:hover {
                text-decoration: underline;
            }
            .sort-indicator {
                font-size: 11px;
                opacity: 0.6;
            }
        </style>

        <!-- KAFELKI ZE STATYSTYKAMI STATUSÓW -->
        <div class="row row-cols-1 row-cols-md-4 g-3 mb-4">
            <div class="col">
                <div class="card text-center shadow-sm h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <h6 class="text-muted mb-1">Wszystkie zgłoszenia</h6>
                        <h3 class="mb-0">{{ total_count }}</h3>
                    </div>
                </div>
            </div>

            {% for s in status_cards %}
                <div class="col">
                    <div class="card text-center shadow-sm h-100">
                        <div class="card-body d-flex flex-column justify-content-center">
                            <h6 class="text-muted mb-1">{{ s.label }}</h6>
                            <h3 class="mb-0">{{ s.count }}</h3>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- FILTRY -->
        <form method="get" class="card mb-4 shadow-sm">
            <input type="hidden" name="sort" value="{{ sort_field }}">
            <input type="hidden" name="dir" value="{{ sort_dir }}">
            <div class="card-body d-flex justify-content-center align-items-end gap-3 flex-wrap">
                <div class="col-md-4">
                    <label class="form-label mb-1">Status</label>
                    <select name="status" class="form-select">
                        <option value="">Wszystkie</option>
                        <option value="NOWE" {% if status_filter == "NOWE" %}selected{% endif %}>NOWE</option>
                        <option value="W_TOKU" {% if status_filter == "W_TOKU" %}selected{% endif %}>W toku</option>
                        <option value="ROZWIAZANE"
                                {% if status_filter == "ROZWIAZANE" %}selected{% endif %}>
                            Rozwiązane
                        </option>
                        <option value="ZAMKNIETE"
                                {% if status_filter == "ZAMKNIETE" %}selected{% endif %}>
                            Zamknięte
                        </option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label mb-1">Kategoria</label>
                    <select name="kategoria" class="form-select">
                        <option value="">Wszystkie</option>
                        {% for value, label in zgloszenia.model.KATEGORIE_ZGLOSZEN %}
                            <option value="{{ value }}"
                                    {% if kategoria_filter == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <button type="submit" class="btn btn-outline-primary">Filtruj</button>
                </div>
            </div>
        </form>

        <!-- TABELA -->
        <div class="card shadow-sm">
            <div class="card-body">
                <h4 class="mb-3">Lista zgłoszeń</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>
                                <a class="sort-link"
                                   href="?status={{ status_filter }}&kategoria={{ kategoria_filter }}&sort=id&dir={% if sort_field == 'id' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                    ID
                                    {% if sort_field == "id" %}
                                        <span class="sort-indicator">{% if sort_dir == "asc" %}&uarr;{% else %}&darr;{% endif %}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a class="sort-link"
                                   href="?status={{ status_filter }}&kategoria={{ kategoria_filter }}&sort=tytul&dir={% if sort_field == 'tytul' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                    Tytul
                                    {% if sort_field == "tytul" %}
                                        <span class="sort-indicator">{% if sort_dir == "asc" %}&uarr;{% else %}&darr;{% endif %}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a class="sort-link"
                                   href="?status={{ status_filter }}&kategoria={{ kategoria_filter }}&sort=kategoria&dir={% if sort_field == 'kategoria' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                    Kategoria zgloszenia
                                    {% if sort_field == "kategoria" %}
                                        <span class="sort-indicator">{% if sort_dir == "asc" %}&uarr;{% else %}&darr;{% endif %}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a class="sort-link"
                                   href="?status={{ status_filter }}&kategoria={{ kategoria_filter }}&sort=status&dir={% if sort_field == 'status' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                    Status
                                    {% if sort_field == "status" %}
                                        <span class="sort-indicator">{% if sort_dir == "asc" %}&uarr;{% else %}&darr;{% endif %}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a class="sort-link"
                                   href="?status={{ status_filter }}&kategoria={{ kategoria_filter }}&sort=priorytet&dir={% if sort_field == 'priorytet' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                    Priorytet
                                    {% if sort_field == "priorytet" %}
                                        <span class="sort-indicator">{% if sort_dir == "asc" %}&uarr;{% else %}&darr;{% endif %}</span>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a class="sort-link"
                                   href="?status={{ status_filter }}&kategoria={{ kategoria_filter }}&sort=data&dir={% if sort_field == 'data' and sort_dir == 'asc' %}desc{% else %}asc{% endif %}">
                                    Data
                                    {% if sort_field == "data" %}
                                        <span class="sort-indicator">{% if sort_dir == "asc" %}&uarr;{% else %}&darr;{% endif %}</span>
                                    {% endif %}
                                </a>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for zgl in zgloszenia %}
                            <tr>
                                <td>
                                    <a href="{% url 'helpdesk:zgloszenie_detail' zgl.id %}">
                                        #{{ zgl.id }}
                                    </a>
                                </td>
                                <td>{{ zgl.tytul }}</td>
                                <td>{{ zgl.get_kategoria_display }}</td>
                                <td>{{ zgl.get_status_display }}</td>
                                <td>{{ zgl.get_priorytet_display }}</td>
                                <td>{{ zgl.data_utworzenia|date:"d F Y H:i" }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-3">
                                    Brak zgłoszeń spełniających kryteria.
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block side_column %}
    <div class="column-side-header">
        Szybkie statystyki
    </div>
    <div class="column-side-body">
        <style>
            .quick-stats {
                display: grid;
                gap: 12px;
            }
            .quick-total {
                padding: 14px 16px;
                border-radius: var(--radius-lg);
                background: linear-gradient(135deg, #e3efff 0%, #f7f9ff 100%);
                border: 1px solid var(--sidebar-border);
                box-shadow: var(--shadow-soft);
            }
            .quick-total__label {
                font-size: 12px;
                letter-spacing: 0.04em;
                text-transform: uppercase;
                color: #5b6475;
                margin-bottom: 4px;
            }
            .quick-total__value {
                font-size: 28px;
                font-weight: 700;
                color: #0f172a;
            }
            .quick-status-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .quick-status {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 10px 12px;
                border-radius: var(--radius-lg);
                border: 1px solid var(--sidebar-border);
                background: #ffffff;
                box-shadow: var(--shadow-soft);
            }
            .quick-status__label {
                font-weight: 600;
                color: #0f172a;
            }
            .quick-status__badge {
                min-width: 36px;
                height: 26px;
                border-radius: 999px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 13px;
            }
            .quick-status--primary .quick-status__badge {
                background: var(--accent-soft);
                color: var(--accent);
            }
            .quick-status--warning .quick-status__badge {
                background: #fff4e5;
                color: #b45309;
            }
            .quick-status--success .quick-status__badge {
                background: #e6f7ed;
                color: #17803d;
            }
            .quick-status--secondary .quick-status__badge {
                background: #e5e7eb;
                color: #374151;
            }
            :root[data-theme='dark'] .quick-total {
                background: linear-gradient(135deg, #11131b 0%, #141623 100%);
                border-color: var(--border-subtle);
            }
            :root[data-theme='dark'] .quick-total__label {
                color: #9ca3af;
            }
            :root[data-theme='dark'] .quick-total__value {
                color: #f9fafb;
            }
            :root[data-theme='dark'] .quick-status {
                background: var(--content-bg);
                border-color: var(--border-subtle);
                box-shadow: none;
            }
            :root[data-theme='dark'] .quick-status__label {
                color: #e5e7eb;
            }
            :root[data-theme='dark'] .quick-status--warning .quick-status__badge {
                background: #3a2f16;
                color: #f7c266;
            }
            :root[data-theme='dark'] .quick-status--success .quick-status__badge {
                background: #13301f;
                color: #7be0a0;
            }
            :root[data-theme='dark'] .quick-status--primary .quick-status__badge {
                background: #1e2c44;
                color: #9bc5ff;
            }
        </style>

        <div class="quick-stats">
            <div class="quick-total">
                <div class="quick-total__label">&#321;&#261;cznie zg&#322;osze&#324;</div>
                <div class="quick-total__value">{{ total_count }}</div>
            </div>

            <div class="quick-status-list">
                {% for s in status_cards %}
                    <div class="quick-status quick-status--{{ s.color|default:'secondary' }}">
                        <span class="quick-status__label">{{ s.label }}</span>
                        <span class="quick-status__badge">{{ s.count }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

